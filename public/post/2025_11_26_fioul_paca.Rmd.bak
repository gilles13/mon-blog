---
title: "Le fioul en PACA"
author: "Gilles"
output:
  html_document:
    code_folding: false
---

```{r, include = FALSE}
knitr::opts_chunk$set(
	message = FALSE,
  comment = "",
	fig.width = 6,
	fig.height = 6)

library(dplyr)
library(tidyr)
library(duckdb)

```

## Fonctions utiles
```{r}
mprof = function(x, denom = "col", sens = c("row", "col"), digits = 1, ...) {
	x |> 
		janitor::adorn_totals(where = sens, ...) |> 
		janitor::adorn_percentages(denominator = denom) |> 
		dplyr::mutate(dplyr::across(tidyselect::where(is.numeric), \(x) x *100)) |> 
		dplyr::mutate(dplyr::across(tidyselect::where(is.numeric), \(x) round(x, digits)))
}


mgroup <- function(x = plog21, var, pond = IPONDL) {
	lvar = length(var)
	if(lvar > 3) stop("La fonction prend max 3 variables de groupement")
	message(lvar, " variable(s) : ", paste0(var, collapse = ", "))
	res = 
		x |> 
		filter(CATL == "1",
					 COMMUNE < "97") |> 
		group_by(across(all_of( {{ var }} ))) |> 
		summarise(
			n_rp = sum( {{ pond }}, na.rm = TRUE),
			n_rp_fioul = sum( {{ pond }}[CMBL == "3"], na.rm = TRUE),
			.groups = "drop") |> 
		collect() |> 
		arrange(across(all_of(var))) |> 
		mutate(n_rp_autre = n_rp - n_rp_fioul) |> 
		select(-n_rp)
	return(res)
}

```

## Liens

[data.gouv.fr](https://www.data.gouv.fr/api/1/datasets/r/fdf5b008-054b-4065-a819-3eb3313f8be7)

## Dwl / link

```{r}
dtpath = "https://www.data.gouv.fr/api/1/datasets/r/fdf5b008-054b-4065-a819-3eb3313f8be7"

conn <- DBI::dbConnect(duckdb(), dbdir = ":memory:")

DBI::dbExecute(conn, "INSTALL httpfs")
DBI::dbExecute(conn, "LOAD httpfs")


plog21 <- dplyr::tbl(conn, paste0("read_parquet('", dtpath, "')"))
```

## Variables
```{r}
sort(colnames(plog21))
```

## Effectif de logt au fioul par région
```{r}
plog21 |> 
	filter(CATL == "1",
				 COMMUNE < "97") |> 
	mgroup(var = c("REGION"), pond = IPONDL) |> 
	janitor::adorn_totals(where = c("row", "col")) |> 
	knitr::kable(format.args = list(big.mark = " "), digits = 0) |> 
	kableExtra::kable_styling(full_width = F) |> 
	kableExtra::row_spec(12, bold = T, color = "white", background = "#D7261E")
```

## Part de logt au fioul par région
```{r}
plog21 |> 
	filter(CATL == "1",
				 COMMUNE < "97") |> 
	mgroup(var = c("REGION"), pond = IPONDL) |> 
	mprof(digits = 1) |> 
	knitr::kable(format.args = list(big.mark = " "), digits = 1) |> 
	kableExtra::kable_styling(full_width = F) |> 
	kableExtra::row_spec(12, bold = T, color = "white", background = "#D7261E")
```
